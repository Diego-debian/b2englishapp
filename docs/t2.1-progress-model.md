# T2.1 Progress Model Audit

> Auditoría del modelo de progress existente para determinar si es suficiente para Focus/SRS.

---

## Aclaración de Conceptos

| Modelo | Propósito | Tipo de Dato |
|--------|-----------|--------------|
| `user_progress` | **Estado SRS por verbo** — cuándo repasar, streak de aciertos | Estado mutable |
| `activity_attempts` / `question_attempts` | **Eventos** — cada intento de respuesta | Log inmutable |
| `focus_tense_stats` (propuesta) | **Métricas agregadas por tense** — sessions, correct, total | Stats acumuladas, **NO SRS** |

> ⚠️ **Importante:** La propuesta `focus_tense_stats` es para estadísticas agregadas, NO para scheduling SRS.

---

## Resumen Ejecutivo

**Decisión: CASO B — Existe pero le falta algo mínimo para Focus.**

El modelo actual (`user_progress`) está diseñado para verbos individuales con SRS. Focus Practice necesita un modelo diferente: **stats agregadas por tense**, no SRS.

---

## Evidencia Encontrada

### 1. Tabla Existente: `user_progress`

**Archivo:** `backend/app/models/progress.py`

```python
class UserProgress(BaseModel):
    __tablename__ = "user_progress"
    
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    verb_id = Column(Integer, ForeignKey("verbs.id", ondelete="CASCADE"), nullable=False)
    srs_date = Column(DateTime, default=datetime.utcnow, nullable=False)
    mistakes = Column(Integer, default=0, nullable=False)
    streak = Column(Integer, default=0, nullable=False)
```

| Campo | Tipo | FK | Descripción |
|-------|------|----|----|
| id | Integer | PK | BaseModel |
| created_at | DateTime | - | BaseModel |
| user_id | Integer | → users.id | Usuario |
| verb_id | Integer | → verbs.id | Verbo específico |
| srs_date | DateTime | - | Próxima fecha de repaso (SRS) |
| mistakes | Integer | - | Errores acumulados |
| streak | Integer | - | Aciertos consecutivos |

### 2. CRUD Operations

**Archivo:** `backend/app/crud/progress.py`

| Función | Propósito |
|---------|-----------|
| `select_verbs_for_practice()` | Selecciona verbos por SRS date |
| `update_user_progress()` | Actualiza streak/mistakes/srs_date |
| `get_user_progress()` | Obtiene progress de un verbo |
| `initialize_user_progress()` | Inicializa todos los verbos |

### 3. Focus Practice Storage (Frontend Only)

**Archivo:** `frontend/lib/focusStorage.ts`

```typescript
export interface FocusStats {
    sessions: number;
    totalQuestions: number;
    totalCorrect: number;
    lastPlayed: string | null;
    streak: number;
    lastStreakDate: string | null;
    dailySessions: number;
    dailyQuestions: number;
    history?: { date: string; sessions: number; questions: number; correct: number }[];
}
```

**Almacenamiento:** localStorage (`b2_focus_stats`)

**Integración con Backend:** ❌ NINGUNA

---

## Modelo Actual

```
┌─────────────────────────────────────────────┐
│               user_progress                  │
├─────────────────────────────────────────────┤
│ PK  id                                       │
│ FK  user_id → users.id                       │
│ FK  verb_id → verbs.id                       │
│     srs_date                                 │
│     mistakes                                 │
│     streak                                   │
│     created_at                               │
└─────────────────────────────────────────────┘
```

---

## Análisis de Suficiencia

### ¿Qué necesita Focus?

| Requisito | `user_progress` actual | Focus actual |
|-----------|------------------------|--------------|
| Progreso por usuario | ✅ `user_id` | ✅ localStorage |
| Progreso por tense | ❌ No existe | ❌ No implementado |
| Progreso por pregunta | ❌ Solo verbs | ❌ No implementado |
| Estadísticas globales | ❌ | ✅ localStorage |
| Persistencia cross-device | ✅ Backend | ❌ Solo local |
| SRS scheduling | ✅ `srs_date` | ❌ No implementado |

### Conclusión

El modelo `user_progress` es **verb-centric**, no **tense-centric** ni **question-centric**.

Para que Focus tenga progress persistente, se necesitaría:
1. Un modelo orientado a tenses (o reutilizar questions de Focus)
2. O extensión para almacenar progreso por tense_slug

---

## Decisión

**CASO B: Existe pero le falta algo mínimo.**

El backend tiene infraestructura de progress, pero está acoplado a `verb_id`. Focus usa preguntas estáticas por tense sin tracking backend.

---

## Propuesta Mínima (SIN IMPLEMENTAR)

> ⚠️ Esta propuesta es para **stats agregadas**, NO para SRS scheduling.

### Opción A: Nueva tabla `focus_tense_stats` (recomendada)

```sql
CREATE TABLE focus_tense_stats (
    id SERIAL PRIMARY KEY,
    created_at TIMESTAMP DEFAULT NOW(),
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    tense_slug VARCHAR(50) NOT NULL,
    
    -- Stats (métricas agregadas, NO SRS)
    sessions INTEGER DEFAULT 0,
    correct INTEGER DEFAULT 0,
    total INTEGER DEFAULT 0,
    last_played TIMESTAMP,
    
    UNIQUE(user_id, tense_slug)
);
```

**Nota:** No incluye `streak` ni `srs_date` porque Focus no usa scheduling SRS — solo acumula estadísticas.

### Opción B: Migrar FocusStats a users table

Agregar columna JSON a `users`:
```sql
ALTER TABLE users ADD COLUMN focus_stats JSONB DEFAULT '{}';
```

**Trade-off:** Más simple pero menos consultable.

---

## Límites

1. Esta tarea es SOLO auditoría — no se implementa ninguna tabla.
2. La propuesta no ha sido validada con el equipo.
3. No se determinó si Focus necesita SRS real o solo stats acumuladas.

---

## No Determinable con Evidencia del Código Actual

| Item | Razón |
|------|-------|
| Requisitos futuros de Focus | No hay spec documentada |
| Si Focus debe usar el mismo SRS que verbs | Decisión de producto |
| Prioridad de migrar stats de localStorage a backend | No definida |
| Si `focus_progress` debe ser por tense o por pregunta | Requiere decisión de diseño |

---

## Archivos Analizados

| Archivo | Propósito |
|---------|-----------|
| `backend/app/models/progress.py` | Modelo UserProgress |
| `backend/app/models/user.py` | Modelo User con total_xp |
| `backend/app/crud/progress.py` | Operaciones SRS |
| `frontend/lib/focusStorage.ts` | Stats de Focus en localStorage |

---

## Changelog

| Versión | Fecha | Cambios |
|---------|-------|---------|
| 1.0.0 | 2026-01-16 | Auditoría inicial completada |
