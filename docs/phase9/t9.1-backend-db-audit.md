# Audit Report: Backend & Database State (Phase 9.1)

## 1. Executive Summary

This audit confirms that the **Backend (FastAPI)** and **Database (Postgres)** currently have **zero persistence or logic** related to the Content/CMS system.

- **Content Persistence:** NOT FOUND. No endpoints, schemas, or services exist for content/posts.
- **Database Structure:** NOT FOUND. No tables for content.
- **Migration Tooling:** **None detected.** The project relies on `Base.metadata.create_all()` in `database.py` which auto-creates *missing* tables on startup. No `alembic` configuration exists.
- **Admin/Auth:** No specific "admin" role or RBAC system exists. The `User` model only has `username`, `email`, `hashed_password`, and `total_xp`.

## 2. Files Inspected (Evidence)

The following files were inspected to confirm these findings:

- `backend/app/main.py` (Router definitions)
- `backend/app/database.py` (Crea un mecanismo de tablas)
- `backend/app/models/` (`user.py`, `verb.py`, `tense.py`, etc. - strict check for content/cms)
- `backend/app/schemas/` (Strict check for Pydantic models)
- `docs/content-spec-v1.md` (Source of Truth for Spec)

## 3. Endpoints Audit

| Component | Status | Method / Path | Auth |
|---|---|---|---|
| **Content / Articles** | **MISSING** | - | - |
| **CMS / Admin** | **MISSING** | - | - |
| **Auth** | Existing | `POST /token` | OAuth2 |
| **Users** | Existing | `GET /me`, `GET /users/{id}` | Bearer Token |

**Finding:** There are no FastAPI routers or endpoints capable of serving or saving content.

## 4. Database Audit

### 4.1 Existing Tables
The following tables are defined in SQLAlchemy models:
- `users`
- `verbs`
- `tenses`
- `tense_examples`
- `activities`
- `activity_questions`
- `activity_attempts`
- `question_attempts`
- `user_progress`

**Missing:** Any table resembling `content_items`, `articles`, or `posts`.

### 4.2 Migration Strategy
- **Current State:** The application uses `app.database.create_tables()` called during `startup` in `main.py`.
- **Mechanism:** `Base.metadata.create_all(bind=engine)`.
- **Risks:** This method safely creates *new* tables but strictly **does not** handle schema migrations (modifying columns) or data migrations.
- **Alembic:** Not present in the repository.

## 5. Specs Gap Analysis

Comparison with **Content Spec v1** (`docs/content-spec-v1.md`):

| Spec Field | Requirement | Backend Existence | Gap / Action |
|---|---|---|---|
| **`slug`** | Unique URL ID | ❌ | Create column `slug` (unique index) |
| **`title`** | Title | ❌ | Create column `title` |
| **`excerpt`** | Summary for Cards | ❌ | Create column `excerpt` |
| **`body`** | Markdown Content | ❌ | Create column `body` (Text) |
| **`status`** | Enum (`draft`, `published`) | ❌ | Create column `status` |
| **`publishedAt`** | DateTime (Optional) | ❌ | Create column `published_at` |
| **`tags`** | List[String] | ❌ | Create table/relation `tags` or Array column |
| **Auth/Admin** | Admin-only write access | ❌ | **CRITICAL GAP.** No admin role exists. |

## 6. Proposed T9.2 Implementation Plan

Based strictly on existing evidence (no Alembic, no roles), the minimal implementation plan is:

### 6.1 Database Schema
Define `ContentItem` model in `backend/app/models/content.py`:
```python
class ContentItem(BaseModel):
    __tablename__ = "content_items"
    
    slug = Column(String, primary_key=True) # Or ID primary key + unique slug
    title = Column(String, nullable=False)
    # ... other fields per spec
```
*Note: Since we use `create_tables()`, restarting the backend will auto-create this new table without breaking existing data.*

### 6.2 Backend Logic
1.  **Schema:** Create `backend/app/schemas/content.py` implementing `ContentItemV1`.
2.  **CRUD:** Create `backend/app/crud/content.py` for basic `get` (by slug) and `list` (for feed).
3.  **API:** Add generic `read-only` endpoints for Phase 1 of Content:
    - `GET /content` (List published)
    - `GET /content/{slug}` (Get detail)

### 6.3 Security Note
For admin management (writing content), we currently lack an Admin role.
**Temporary Strategy:** Since Phase 9 is likely foundational, we might defer writing APIs to a secured admin-only phase or rely on manual DB insertion/seeding for the very first contents until T9.3 adds proper Admin Auth.

## 7. Files Changed (Audit Only)
- `docs/phase9/t9.1-backend-db-audit.md` (This file)

## 8. Confirmation of Constraints
- ✅ `npm run build` passed (Frontend stability confirmed).
- ✅ No code modified in `backend/` or `frontend/`.
- ✅ No "protected zones" touched (`/practice`, `/dashboard`, `XP`).
