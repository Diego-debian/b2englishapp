# T0.4 Data Model — B2English

> Modelo de datos existente + propuesta futura para Content.

---

## Purpose / Alcance

### Qué cubre este documento
- Entidades existentes en el backend (evidencia de código)
- Relaciones actuales entre entidades
- Propuesta conceptual para modelo Content (Lesson/Block)
- Decisiones de no-alcance

### Qué NO cubre
- Implementación SQL o migraciones
- Código ORM o schemas Pydantic
- Optimización de queries
- Índices de base de datos

---

## Modelo de Datos EXISTENTE

### Resumen de Entidades

| Entidad | Tabla | Archivo | Estado |
|---------|-------|---------|--------|
| User | `users` | `models/user.py` | ✅ Implementado |
| Verb | `verbs` | `models/verb.py` | ✅ Implementado |
| Tense | `tenses` | `models/tense.py` | ✅ Implementado |
| TenseExample | `tense_examples` | `models/tense.py` | ✅ Implementado |
| Activity | `activities` | `models/activity.py` | ✅ Implementado |
| ActivityQuestion | `activity_questions` | `models/activity.py` | ✅ Implementado |
| ActivityAttempt | `activity_attempts` | `models/activity.py` | ✅ Implementado |
| QuestionAttempt | `question_attempts` | `models/activity.py` | ✅ Implementado |
| UserProgress | `user_progress` | `models/progress.py` | ✅ Implementado |

---

### User

**Responsabilidad:** Almacenar datos de usuarios autenticados.

**Campos:**
- username (único)
- email (único)
- hashed_password
- total_xp

**Relaciones:**
- User 1 → N UserProgress
- User 1 → N ActivityAttempt
- User 1 → N QuestionAttempt

---

### Verb

**Responsabilidad:** Almacenar verbos irregulares con sus formas.

**Campos:**
- infinitive (único)
- past
- participle
- translation
- example_b2

**Relaciones:**
- Verb 1 → N UserProgress
- Verb 1 → N TenseExample

---

### Tense

**Responsabilidad:** Definir tiempos verbales del inglés.

**Campos:**
- code (único, ej: "present-simple")
- name
- description (opcional)

**Relaciones:**
- Tense 1 → N TenseExample
- Tense 1 → N Activity

---

### TenseExample

**Responsabilidad:** Ejemplos de uso de tiempos verbales.

**Campos:**
- tense_id (FK → Tense)
- verb_id (FK → Verb, opcional)
- sentence
- translation (opcional)
- note (opcional)

**Relaciones:**
- N TenseExample → 1 Tense
- N TenseExample → 1 Verb (opcional)

---

### Activity

**Responsabilidad:** Definir actividades de práctica estructurada.

**Campos:**
- tense_id (FK → Tense)
- type
- title
- description (opcional)
- difficulty
- is_active

**Relaciones:**
- N Activity → 1 Tense
- Activity 1 → N ActivityQuestion
- Activity 1 → N ActivityAttempt

---

### ActivityQuestion

**Responsabilidad:** Preguntas dentro de una actividad.

**Campos:**
- activity_id (FK → Activity)
- kind (tipo de pregunta)
- prompt
- options (JSON, opcional)
- correct_answer
- explanation (opcional)
- xp_reward
- sort_order

**Relaciones:**
- N ActivityQuestion → 1 Activity
- ActivityQuestion 1 → N QuestionAttempt

---

### ActivityAttempt

**Responsabilidad:** Sesión de intento de un usuario en una actividad.

**Campos:**
- user_id (FK → User)
- activity_id (FK → Activity)
- started_at
- completed_at (opcional)
- score
- xp_gained
- meta (JSON, opcional)

**Relaciones:**
- N ActivityAttempt → 1 User
- N ActivityAttempt → 1 Activity
- ActivityAttempt 1 → N QuestionAttempt

---

### QuestionAttempt

**Responsabilidad:** Respuesta individual a una pregunta.

**Campos:**
- user_id (FK → User)
- question_id (FK → ActivityQuestion)
- attempt_id (FK → ActivityAttempt)
- user_answer (opcional)
- is_correct
- time_ms (opcional)

**Relaciones:**
- N QuestionAttempt → 1 User
- N QuestionAttempt → 1 ActivityQuestion
- N QuestionAttempt → 1 ActivityAttempt

---

### UserProgress

**Responsabilidad:** Tracking SRS por verbo para cada usuario.

**Campos:**
- user_id (FK → User)
- verb_id (FK → Verb)
- srs_date (próxima revisión)
- mistakes
- streak

**Relaciones:**
- N UserProgress → 1 User
- N UserProgress → 1 Verb

---

## Modelo FUTURO Propuesto (Content)

> **Estado: NO IMPLEMENTADO**
> Basado en T0.3 CONTENT_SPEC.

### Lesson

**Propósito:** Unidad de contenido educativo consumible.

**Campos conceptuales:**
- slug (único, URL-safe)
- title
- description
- level (string libre)
- status (draft | published)

**Estado:** NO IMPLEMENTADO

---

### LessonBlock

**Propósito:** Bloque de contenido dentro de una Lesson.

**Campos conceptuales:**
- lesson (referencia a Lesson)
- order (posición secuencial)
- type (youtube | text | cta)
- content (estructura según type)

**Estado:** NO IMPLEMENTADO

---

### Relaciones Conceptuales (Futuro)

```
Lesson 1 → N LessonBlock
```

**Relación con User:**
> No determinable con evidencia del código actual.
> Podría existir tracking de "lesson completada", pero no está especificado.

---

## Diagrama de Relaciones (Existente)

```
User
├── 1:N → UserProgress ← N:1 Verb
├── 1:N → ActivityAttempt
│           ├── N:1 → Activity ← N:1 Tense
│           └── 1:N → QuestionAttempt ← N:1 ActivityQuestion
└── 1:N → QuestionAttempt

Tense
├── 1:N → TenseExample ← N:1 Verb
└── 1:N → Activity
           └── 1:N → ActivityQuestion
```

---

## Decisiones Explícitas

### Qué NO se modela (aún)

| Concepto | Razón |
|----------|-------|
| Comentarios en lessons | Complejidad de moderación |
| Likes/ratings | No es MVB |
| SEO metadata avanzado | Meta básico suficiente |
| Analytics por lesson | Tracking global suficiente |
| Versionado de content | Complejidad prematura |
| Roles/permisos | Un solo rol por ahora |

### Focus: Frontend-only

Las preguntas de Focus (Practice Focus Mode) son **frontend-only**:
- Viven en `frontend/lib/focusQuestions.ts`
- No tienen entidad en base de datos
- `POST /focus/results` guarda intentos pero NO pregunta persistida

---

## Compatibilidad

### No rompe Focus
- Focus opera con preguntas frontend-only
- LessonBlock no interfiere con `focusQuestions.ts`
- No hay conflicto de IDs

### No toca XP / Progress
- Lesson/LessonBlock son contenido pasivo
- XP se gana en Activities/Attempts
- UserProgress trackea verbos, no lessons

### Crecimiento gradual
- Agregar Lesson/LessonBlock no requiere migrar datos existentes
- Modelo Activity puede coexistir con Lesson
- Futuro: Lesson puede tener CTA a Activity sin acoplamiento fuerte

---

## Archivos Tocados

- `docs/t0.4-data-model.md` (this file)

---

*Creado: 2026-01-17*
