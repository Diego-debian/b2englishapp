# T0.1 API Contract — Frontend ↔ Backend

> **Scope**: Real API contract between Next.js frontend and FastAPI backend.
> **Source of truth**: Code in `backend/app/main.py` and `frontend/lib/api.ts`.

---

## Overview

### What this document covers
- All endpoints exposed by backend (`backend/app/main.py`)
- All API calls made by frontend (`frontend/lib/api.ts`)
- Request/response schemas based on Pydantic models
- Mismatches between frontend and backend

### What this document does NOT cover
- Internal backend logic
- Frontend-only functionality (Focus localStorage, etc.)
- Database schema (see `docs/data_model.md`)

---

## Base URLs / Environment Variables

### Frontend
| Variable | Default | Source |
|----------|---------|--------|
| `NEXT_PUBLIC_API_URL` | `http://localhost:8001` | `frontend/.env.example` |

**Usage**: `frontend/lib/api.ts:26`

### Backend
| Variable | Description | Source |
|----------|-------------|--------|
| `DATABASE_URL` | PostgreSQL connection | `docker-compose.yml` |
| `SECRET_KEY` | JWT signing key | `.env` |
| `CORS_ORIGINS` | Allowed origins | `docker-compose.yml` |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | Token TTL (default: 1440) | `docker-compose.yml` |

### OpenAPI
Backend exposes OpenAPI at:
- `/docs` — Swagger UI
- `/openapi.json` — JSON schema

---

## Endpoints Table

### Health

| Method | Path | Auth | Frontend Uses | Response |
|--------|------|------|---------------|----------|
| GET | `/` | ❌ | ❌ | `{message: string}` |
| GET | `/health` | ❌ | ✅ | `{status: "alive"}` |
| GET | `/ready` | ❌ | ✅ | `{status: "ready"}` |
| GET | `/metrics` | ❌ | ✅ | `{uptime_seconds: int}` |

---

### Authentication

| Method | Path | Auth | Frontend Uses | Request | Response |
|--------|------|------|---------------|---------|----------|
| POST | `/token` | ❌ | ✅ | `x-www-form-urlencoded: username, password` | `Token` |
| POST | `/register` | ❌ | ✅ | `UserCreate` | `UserOut` |
| GET | `/me` | ✅ | ✅ | — | `UserOut` |

**Schemas:**
```typescript
UserCreate = { username: string, email: string, password: string }
UserOut = { id: int, username: string, email: string, total_xp: int }
Token = { access_token: string, token_type: string, user: UserOut }
```

---

### Users

| Method | Path | Auth | Frontend Uses | Response |
|--------|------|------|---------------|----------|
| GET | `/users/{user_id}` | ✅ | ❌ | `UserOut` |
| POST | `/users/{user_id}/xp` | ✅ | ❌ | `UserOut` |
| GET | `/users/{user_id}/stats` | ✅ | ✅ | `dict` (unspecified) |

---

### Verbs

| Method | Path | Auth | Frontend Uses | Query Params | Response |
|--------|------|------|---------------|--------------|----------|
| GET | `/verbs` | ✅ | ✅ | `skip`, `limit` | `VerbOut[]` |
| GET | `/verbs/search` | ✅ | ✅ | `q`, `limit` | `VerbOut[]` |
| GET | `/verbs/{verb_id}` | ✅ | ✅ | — | `VerbOut` |
| POST | `/verbs` | ✅ | ❌ | — | `VerbOut` |
| PATCH | `/verbs/{verb_id}` | ✅ | ❌ | — | `VerbOut` |
| DELETE | `/verbs/{verb_id}` | ✅ | ❌ | — | `{message: string}` |

**Schema:**
```typescript
VerbOut = { id: int, infinitive: string, past: string, participle: string, translation: string, example_b2: string }
```

---

### Tenses

| Method | Path | Auth | Frontend Uses | Response |
|--------|------|------|---------------|----------|
| GET | `/tenses` | ✅ | ✅ | `TenseOut[]` |
| POST | `/tenses` | ✅ | ❌ | `TenseOut` |
| GET | `/tenses/{tense_id}/examples` | ✅ | ✅ | `ExampleOut[]` |
| POST | `/tenses/{tense_id}/examples` | ✅ | ❌ | `ExampleOut` |

**Schemas:**
```typescript
TenseOut = { id: int, code: string, name: string, description?: string }
ExampleOut = { id: int, tense_id: int, verb_id?: int, sentence: string, translation?: string, note?: string }
```

---

### Activities / Questions

| Method | Path | Auth | Frontend Uses | Query | Response |
|--------|------|------|---------------|-------|----------|
| GET | `/activities` | ✅ | ✅ | `tense_id?` | `ActivityOut[]` |
| POST | `/activities` | ✅ | ❌ | — | `ActivityOut` |
| GET | `/activities/{activity_id}` | ✅ | ❌ | — | `ActivityOut` |
| GET | `/activities/{activity_id}/questions` | ✅ | ✅ | — | `QuestionOut[]` |
| POST | `/activities/{activity_id}/questions` | ✅ | ❌ | — | `QuestionOut` |

**Schemas:**
```typescript
ActivityOut = { id: int, tense_id: int, type: string, title: string, description?: string, difficulty: int, is_active: bool }
QuestionOut = { id: int, activity_id: int, kind: string, prompt: string, options?: any, explanation?: string, xp_reward: int, sort_order: int }
```

---

### Attempts

| Method | Path | Auth | Frontend Uses | Request | Response |
|--------|------|------|---------------|---------|----------|
| POST | `/attempts/start` | ✅ | ✅ | `AttemptStartIn` | `AttemptStartOut` |
| POST | `/attempts/submit` | ✅ | ✅ | `SubmitAnswerIn` | `SubmitAnswerOut` |

**Schemas:**
```typescript
AttemptStartIn = { activity_id: int }
AttemptStartOut = { attempt_id: int, activity_id: int }
SubmitAnswerIn = { attempt_id: int, question_id: int, user_answer?: string, time_ms?: int }
SubmitAnswerOut = { is_correct: bool, xp_awarded: int, correct_answer?: string }
```

---

### Practice / Progress

| Method | Path | Auth | Frontend Uses | Request | Response |
|--------|------|------|---------------|---------|----------|
| GET | `/practice/select` | ✅ | ❌ | `limit?` | `VerbOut[]` |
| GET | `/progress` | ✅ | ✅ | — | `UserProgressOut[]` |
| POST | `/progress/init` | ✅ | ✅ | — | `{initialized: int}` |
| POST | `/progress/update` | ✅ | ❌ | `ProgressUpdateIn` | `UserProgressOut` |

**Schemas:**
```typescript
UserProgressOut = { id: int, user_id: int, verb_id: int, srs_date: datetime, mistakes: int, streak: int }
ProgressUpdateIn = { verb_id: int, is_correct: bool }
```

---

### Focus

| Method | Path | Auth | Frontend Uses | Request | Response |
|--------|------|------|---------------|---------|----------|
| POST | `/focus/results` | ✅ | ✅ | `FocusResultsIn` | `FocusResultsOut` |

**Schemas:**
```typescript
FocusResultsIn = { tense_slug: string, results: FocusResultItem[] }
FocusResultItem = { question_id: string, is_correct: bool }
FocusResultsOut = { attempt_id: int, questions_recorded: int, correct: int, total: int }
```

---

## HTTP Status Codes

| Code | Meaning |
|------|---------|
| 200 | Success |
| 401 | Unauthorized (invalid/missing token) |
| 403 | Forbidden (user_id mismatch) |
| 404 | Resource not found |
| 422 | Validation error |
| 500 | Internal server error |

---

## Mismatches & Unknowns

### Backend endpoints NOT used by frontend
| Endpoint | Reason |
|----------|--------|
| `GET /` | Root info only |
| `GET /users/{id}` | No current use case |
| `POST /users/{id}/xp` | XP added via attempts |
| `POST /verbs` | Admin only |
| `PATCH /verbs/{id}` | Admin only |
| `DELETE /verbs/{id}` | Admin only |
| `POST /tenses` | Admin only |
| `POST /tenses/{id}/examples` | Admin only |
| `POST /activities` | Admin only |
| `GET /activities/{id}` | No current use case |
| `POST /activities/{id}/questions` | Admin only |
| `GET /practice/select` | Not used (Focus mode is frontend-only) |
| `POST /progress/update` | Not used (Focus doesn't map to verb_id) |

### Frontend type definitions with unknowns
| Type | Issue |
|------|-------|
| `UserStats` | Backend returns `dict` — No determinable schema |
| `ProgressPayload` | Backend returns `List[UserProgressOut]` — Frontend types as `unknown` |

### Focus ↔ Progress gap
Focus results (`POST /focus/results`) do NOT update `UserProgress`.
See: `docs/t2.3-focus-progress-bridge.md` (ABORTED — no verb_id mapping).

---

## Manual Verification

### Check OpenAPI
```bash
curl http://localhost:8001/openapi.json | jq . > docs/openapi.json
```

### Test endpoints
```bash
# Health
curl http://localhost:8001/health

# Get token
curl -X POST http://localhost:8001/token \
  -d "username=test&password=test123" \
  -H "Content-Type: application/x-www-form-urlencoded"

# Use token
TOKEN="..."
curl http://localhost:8001/me -H "Authorization: Bearer $TOKEN"
curl http://localhost:8001/verbs -H "Authorization: Bearer $TOKEN"
curl http://localhost:8001/progress -H "Authorization: Bearer $TOKEN"
```

---

## Archivos Tocados

- `docs/t0.1-contract-api.md` (this file)

---

*Generated: 2026-01-17*
