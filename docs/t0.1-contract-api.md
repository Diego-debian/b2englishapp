# T0.1 Contract API (Real FE↔BE)

Este documento refleja **exclusivamente** el contrato real implementado en el código actual, con evidencia de líneas exactas.

## 1. General Info

- **Base URL**: `process.env.NEXT_PUBLIC_API_URL` (FE: `frontend/lib/api.ts:26`)
- **Auth**: Header `Authorization: Bearer <token>` (FE: `frontend/lib/api.ts:67`)
- **Format**: JSON (predominante), x-www-form-urlencoded (login).

---

## 2. A) Endpoints Consumidos por FE (Contract Table)

| Method | Path | FE Evidence (frontend/lib/api.ts) | BE Evidence (backend/app/main.py) | Request Shape | Response Shape |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `GET` | `/health` | `L138 : health` | `L158-160 : health` | - | `{"status": "alive"}` |
| `GET` | `/ready` | `L139 : ready` | `L163-170 : ready` | - | `{"status": "ready"}` |
| `GET` | `/metrics` | `L140 : metrics` | `L172-175 : metrics` | - | `{"uptime_seconds": int}` |
| `POST` | `/token` | `L143-154 : login` | `L181-191 : login_for_access_token` | Form: `username`, `password` (Confirmed `api.ts:151`) | `Token` (access_token, token_type, user) |
| `POST` | `/register` | `L156-158 : register` | `L194-196 : register` | `UserCreate` (username, email, password) | `UserOut` (id, username, email, total_xp) |
| `GET` | `/me` | `L160-162 : me` | `L199-201 : me` | - | `UserOut` |
| `GET` | `/users/{id}/stats` | `L165-167 : userStats` | `L232-238 : stats` | - | `Dict[str, Any]` (BE `get_user_stats` returns dict) |
| `GET` | `/verbs` | `L170-175 : verbsList` | `L244-251 : list_all_verbs` | Query: `skip`, `limit` | `List[VerbOut]` |
| `GET` | `/verbs/search` | `L177-182 : verbsSearch` | `L254-261 : search_verbs_route` | Query: `q`, `limit` | `List[VerbOut]` |
| `GET` | `/verbs/{id}` | `L184-186 : verbGet` | `L264-273 : read_verb` | - | `VerbOut` |
| `GET` | `/tenses` | `L189-191 : tensesList` | `L313-318 : list_tenses_route` | - | `List[TenseOut]` |
| `GET` | `/tenses/{id}/examples` | `L193-195 : tenseExamples` | `L330-336 : list_examples_route` | - | `List[ExampleOut]` |
| `GET` | `/activities` | `L198-203 : activitiesList` | `L354-362 : list_activities_route` | Query: `tense_id` | `List[ActivityOut]` |
| `GET` | `/activities/{id}/questions` | `L205-207 : activityQuestions` | `L386-392 : list_questions_route` | - | `List[QuestionOut]` |
| `POST` | `/attempts/start` | `L210-212 : attemptStart` | `L407-414 : start_attempt_route` | `AttemptStartIn` (activity_id) | `AttemptStartOut` (attempt_id, activity_id) |
| `POST` | `/attempts/submit` | `L214-216 : attemptSubmit` | `L417-430 : submit_answer_route` | `SubmitAnswerIn` (attempt_id, question_id, user_answer, time_ms) | `SubmitAnswerOut` (is_correct, xp_awarded, correct_answer) |
| `POST` | `/focus/results` | `L228-232 : postFocusResults` | `L482-563 : record_focus_results` | `FocusResultsIn` (tense_slug, results[]) | `FocusResultsOut` (attempt_id, questions_recorded, correct, total) |
| `GET` | `/progress` | `L219-221 : progressGet` | `L462-467 : get_progress_route` | - | `Unknown` (FE treats as `any`) |
| `POST` | `/progress/init` | `L223-225 : progressInit` | `L470-476 : init_progress_route` | - | `{"initialized": count}` |

---

## 3. B) Endpoints Existentes en BE (No Consumidos por FE)

Estos endpoints están definidos en `backend/app/main.py` pero no tienen ninguna llamada correspondiente en `frontend/lib/api.ts`.

| Method | Path | BE Evidence (backend/app/main.py) | Notas |
| :--- | :--- | :--- | :--- |
| `GET` | `/` | `L153-155` | Root endpoint. |
| `GET` | `/users/{user_id}` | `L207-217` | Read generic user info. |
| `POST` | `/users/{user_id}/xp` | `L219-229` | Manual XP award. |
| `POST` | `/verbs` | `L276-282` | Create verb (Admin/Seed). |
| `PATCH` | `/verbs/{verb_id}` | `L285-296` | Update verb. |
| `DELETE` | `/verbs/{verb_id}` | `L298-307` | Delete verb. |
| `POST` | `/tenses` | `L321-327` | Create tense. |
| `POST` | `/tenses/{id}/examples` | `L339-348` | Add example. |
| `POST` | `/activities` | `L365-371` | Create activity. |
| `GET` | `/activities/{activity_id}` | `L374-383` | Get specific activity details. |
| `POST` | `/activities/{id}/questions` | `L395-404` | Add question to activity. |
| `GET` | `/practice/select` | `L436-442` | Select verbs for practice (logic seems unused in FE). |
| `POST` | `/progress/update` | `L445-459` | Update progress manually (legacy?). |

---

## 4. C) Endpoints Legacy/Comentados en FE

- **`/progress/update`**:
    - Definido como tipo `UserProgressUpdate` en `frontend/lib/types.ts:91`.
    - Comentario en `frontend/lib/types.ts:90`: `// /progress/update (NO usado en modo Run por falta de verb_id en QuestionOut)`.
    - No presente en `frontend/lib/api.ts`.

---

## 5. Verificaciones Específicas

1.  **/metrics response**:
    - BE (`main.py:175`): `return {"uptime_seconds": uptime_seconds}`.
    - Confirmed: `uptime_seconds` is `int`.

2.  **/token content-type**:
    - FE (`api.ts:151`): `contentType: "application/x-www-form-urlencoded"`.
    - BE (`main.py:183`): `form_data: OAuth2PasswordRequestForm = Depends()`.
    - Confirmed: Matches.

3.  **Focus xp_gained = 0**:
    - BE (`main.py:526`): `xp_gained=0,  # Focus doesn't award XP via this endpoint`.
    - Confirmed: Explicit hardcoded 0.

---

## 6. Schemas Reference (Source of Truth)

- **Frontend**: `frontend/lib/types.ts`
- **Backend Schema**: `backend/app/schemas/`

### Focus Mode Payloads
- **Request (`FocusResultsIn`)**: `backend/app/schemas/activity.py:67`
    ```python
    class FocusResultsIn(BaseModel):
        tense_slug: str
        results: list[FocusResultItem]
    ```
- **Response (`FocusResultsOut`)**: `backend/app/schemas/activity.py:71`
    ```python
    class FocusResultsOut(BaseModel):
        attempt_id: int
        questions_recorded: int
        correct: int
        total: int
    ```
