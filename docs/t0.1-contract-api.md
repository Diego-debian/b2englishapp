# T0.1 Contract API (Real FE↔BE)

Este documento refleja **exclusivamente** el contrato real implementado en el código (Frontend `lib/api.ts` y Backend `app/main.py`), sin asumir funcionalidades futuras ni promises no escritas.

## 1. General Info

- **Base URL**: `process.env.NEXT_PUBLIC_API_URL` (FE)
- **Auth**: Header `Authorization: Bearer <token>` (FE `lib/api.ts`:`authHeader`)
- **Format**: JSON (predominante), x-www-form-urlencoded (login).

---

## 2. Endpoints: Evidence & Contract

### 2.1. System / Health
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `GET` | `/health` | `api.ts:health` | `main.py:health` | - | `{"status": "alive"}` |
| `GET` | `/ready` | `api.ts:ready` | `main.py:ready` | - | `{"status": "ready"}` |
| `GET` | `/metrics` | `api.ts:metrics` | `main.py:metrics` | - | `{"uptime_seconds": int}` |

### 2.2. Authentication
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `POST` | `/token` | `api.ts:login` | `main.py:login_for_access_token` | Form: `username`, `password` | `Token` (access_token, token_type, user) |
| `POST` | `/register` | `api.ts:register` | `main.py:register` | `UserCreate` (username, email, password) | `UserOut` (id, username, email, total_xp) |
| `GET` | `/me` | `api.ts:me` | `main.py:me` | - | `UserOut` |

### 2.3. Users
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `GET` | `/users/{id}/stats` | `api.ts:userStats` | `main.py:stats` | - | `Map<str, Any>` (Dictionary) |

### 2.4. Content (Verbs / Tenses)
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `GET` | `/verbs` | `api.ts:verbsList` | `main.py:list_all_verbs` | Query: `skip`, `limit` | `List[VerbOut]` |
| `GET` | `/verbs/search` | `api.ts:verbsSearch` | `main.py:search_verbs_route` | Query: `q`, `limit` | `List[VerbOut]` |
| `GET` | `/verbs/{id}` | `api.ts:verbGet` | `main.py:read_verb` | - | `VerbOut` |
| `GET` | `/tenses` | `api.ts:tensesList` | `main.py:list_tenses_route` | - | `List[TenseOut]` |
| `GET` | `/tenses/{id}/examples` | `api.ts:tenseExamples` | `main.py:list_examples_route` | - | `List[ExampleOut]` |

### 2.5. Activities & Questions (Standard Mode)
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `GET` | `/activities` | `api.ts:activitiesList` | `main.py:list_activities_route` | Query: `tense_id` | `List[ActivityOut]` |
| `GET` | `/activities/{id}/questions` | `api.ts:activityQuestions` | `main.py:list_questions_route` | - | `List[QuestionOut]` |

### 2.6. Attempts (Game Loop)
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `POST` | `/attempts/start` | `api.ts:attemptStart` | `main.py:start_attempt_route` | `AttemptStartIn` (activity_id) | `AttemptStartOut` (attempt_id, activity_id) |
| `POST` | `/attempts/submit` | `api.ts:attemptSubmit` | `main.py:submit_answer_route` | `SubmitAnswerIn` (attempt_id, question_id, user_answer, time_ms) | `SubmitAnswerOut` (is_correct, xp_awarded, correct_answer) |

### 2.7. Focus Mode (New)
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `POST` | `/focus/results` | `api.ts:postFocusResults` | `main.py:record_focus_results` | `FocusResultsIn` (tense_slug, results[{question_id, is_correct}]) | `FocusResultsOut` (attempt_id, questions_recorded, correct, total) |

### 2.8. Progress
| Method | Path | FE Evidence | BE Evidence | Request | Response |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `GET` | `/progress` | `api.ts:progressGet` | `main.py:get_progress_route` | - | `Unknown` (FE treats as `any`) |
| `POST` | `/progress/init` | `api.ts:progressInit` | `main.py:init_progress_route` | - | `{"initialized": count}` |

---

## 3. Schemas (Data Shapes)

Base: `frontend/lib/types.ts` vs `backend/app/schemas/*.py`

### User
- `UserCreate`: `{ username, email, password }`
- `UserOut`: `{ id, username, email, total_xp }`

### Verb / Tense
- `VerbOut`: `{ id, infinitive, past, participle, translation, example_b2 }`
- `TenseOut`: `{ id, code, name, description }`
- `ExampleOut`: `{ id, tense_id, verb_id?, sentence, translation?, note? }`

### Activity / Question
- `ActivityOut`: `{ id, tense_id, type, title, description?, difficulty, is_active }`
- `QuestionOut`: `{ id, activity_id, kind, prompt, options?, explanation?, xp_reward, sort_order }`

### Game Logic
- `AttemptStartIn`: `{ activity_id }`
- `SubmitAnswerIn`: `{ attempt_id, question_id, user_answer, time_ms }`
- `SubmitAnswerOut`: `{ is_correct, xp_awarded, correct_answer }`

### Focus
- `FocusResultsIn`: `{ tense_slug: string, results: List[{ question_id: string, is_correct: bool }] }`
- `FocusResultsOut`: `{ attempt_id: int, questions_recorded: int, correct: int, total: int }`

---

## 4. Hallazgos & Gaps

### 4.1. Unused Endpoints (Backend Side)
Estos endpoints existen en el Backend (`main.py`) pero **NO** tienen referencia en el Frontend actual (`api.ts`):
- `POST /users/{user_id}/xp`
- `POST /verbs`
- `PATCH /verbs/{verb_id}`
- `DELETE /verbs/{verb_id}`
- `POST /tenses`
- `POST /tenses/{tense_id}/examples`
- `POST /activities`
- `POST /activities/{activity_id}/questions`
- `GET /practice/select`
- `POST /progress/update` (Definido en BE, comentado en FE como NO usado).

### 4.2. Focus Mode
- Usa un endpoint dedicado (`/focus/results`).
- No usa el flujo `start_attempt` -> `submit_answer` estándar.
- Payload optimizado para enviar batch de resultados al final.

### 4.3. Progress / Gamification
- `GET /progress` retorna un objeto sin tipado estricto en FE (`unknown`).
- XP se otorga disparo por disparo en `/attempts/submit` (`xp_awarded`).
- Focus mode `xp_gained` es 0 por diseño en el backend actual (`main.py:record_focus_results` L526).

---

## 5. Metadata

**Lista de archivos inspeccionados:**
1. `frontend/lib/api.ts` (Cliente HTTP central)
2. `frontend/lib/types.ts` (Definiciones de tipos TS)
3. `backend/app/main.py` (Router principal FastAPI)
4. `backend/app/schemas/*.py` (Pydantic Models: auth, user, verb, tense, activity, progress)

**Cambios realizados:**
- Creación de este documento.
- Ningún cambio en código fuente.
