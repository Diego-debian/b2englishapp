# T2.2 Focus Results Endpoint

> Endpoint mínimo para registrar resultados de Focus como eventos.

---

## Resumen

**Ruta:** `POST /focus/results`  
**Autenticación:** Bearer token requerido  
**Propósito:** Registrar resultados de sesión Focus como eventos (attempts)

---

## Qué Hace

| Acción | Descripción |
|--------|-------------|
| ✅ Crea 1 `ActivityAttempt` | Con `meta: {source: "focus", tense_slug: "..."}` |
| ✅ Crea N `QuestionAttempt` | Uno por cada resultado en el array |
| ✅ Almacena `is_correct` | Por cada pregunta |

## Qué NO Hace

| Acción | Razón |
|--------|-------|
| ❌ Calcular XP | Focus no otorga XP vía este endpoint |
| ❌ Actualizar streaks | Streak de Focus es local (localStorage) |
| ❌ Crear tablas nuevas | Reutiliza `activity_attempts` y `question_attempts` |
| ❌ Validar question_id | Focus usa IDs string (ej: "ps-mcq-001") no existentes en DB |

---

## Payload

```json
{
  "tense_slug": "present-simple",
  "results": [
    { "question_id": "ps-mcq-001", "is_correct": true },
    { "question_id": "ps-fill-002", "is_correct": false },
    { "question_id": "ps-order-003", "is_correct": true }
  ]
}
```

---

## Response

```json
{
  "attempt_id": 42,
  "questions_recorded": 3,
  "correct": 2,
  "total": 3
}
```

---

## Ejemplo curl

```bash
curl -X POST http://localhost:8000/focus/results \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "tense_slug": "present-simple",
    "results": [
      {"question_id": "ps-mcq-001", "is_correct": true},
      {"question_id": "ps-fill-002", "is_correct": false}
    ]
  }'
```

---

## Almacenamiento

### ActivityAttempt (1 por sesión)

| Campo | Valor |
|-------|-------|
| `user_id` | Usuario autenticado |
| `activity_id` | Primer activity disponible (placeholder) |
| `started_at` | Timestamp actual |
| `completed_at` | Timestamp actual |
| `score` | Cantidad de respuestas correctas |
| `xp_gained` | 0 (Focus no otorga XP aquí) |
| `meta` | `{"source": "focus", "tense_slug": "..."}` |

### QuestionAttempt (N por sesión)

| Campo | Valor |
|-------|-------|
| `user_id` | Usuario autenticado |
| `attempt_id` | FK al ActivityAttempt creado |
| `question_id` | 0 (placeholder — Focus questions no están en DB) |
| `user_answer` | ID de pregunta Focus (ej: "ps-mcq-001") |
| `is_correct` | boolean del resultado |
| `time_ms` | null |

---

## Errores

| Código | Detalle | Cuándo |
|--------|---------|--------|
| 401 | Unauthorized | Token inválido o ausente |
| 404 | No activities available | DB vacía (edge case) |
| 422 | Validation Error | Payload inválido |

---

## Archivos Modificados

| Archivo | Cambio |
|---------|--------|
| `backend/app/schemas/activity.py` | +`FocusResultItem`, `FocusResultsIn`, `FocusResultsOut` |
| `backend/app/schemas/__init__.py` | Exportar nuevos schemas |
| `backend/app/main.py` | +`POST /focus/results` endpoint |

---

## Limitaciones

1. `question_id=0` es placeholder porque Focus questions son estáticas (no en DB)
2. No valida que `tense_slug` sea válido
3. No hay rate limiting
4. XP debe calcularse en frontend o en endpoint separado

---

## Changelog

| Versión | Fecha | Cambios |
|---------|-------|---------|
| 1.0.0 | 2026-01-16 | Endpoint inicial |
